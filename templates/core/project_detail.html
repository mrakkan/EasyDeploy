{% extends 'core/base.html' %}

{% block title %}{{ project.name }} - EasyDeploy{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1><i class="bi bi-folder"></i> {{ project.name }}</h1>
        <p class="text-muted">No description available</p>
    </div>
    <div class="btn-group" role="group">
        {% if project.status == 'running' %}
            <button class="btn btn-warning stop-project" data-project-id="{{ project.id }}">
                <i class="bi bi-stop-circle"></i> Stop
            </button>
            <a href="http://localhost:{{ project.exposed_port }}" target="_blank" class="btn btn-success">
                <i class="bi bi-box-arrow-up-right"></i> Open App
            </a>
        {% else %}
            <button class="btn btn-success deploy-project" data-project-id="{{ project.id }}">
                <i class="bi bi-play-circle"></i> Deploy
            </button>
        {% endif %}
        <button class="btn btn-danger delete-project" data-project-id="{{ project.id }}">
            <i class="bi bi-trash"></i> Delete
        </button>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Project Info</h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Status:</dt>
                    <dd class="col-sm-8">
                        {% if project.status == 'running' %}
                            <span class="badge bg-success">Running</span>
                        {% elif project.status == 'deploying' %}
                            <span class="badge bg-warning">Deploying</span>
                        {% elif project.status == 'failed' %}
                            <span class="badge bg-danger">Failed</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ project.status|title }}</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-4">Port:</dt>
                    <dd class="col-sm-8">
                        {% if project.exposed_port %}
                            <span class="badge bg-info">{{ project.exposed_port }}</span>
                        {% else %}
                            <span class="text-muted">Not assigned</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-4">Visibility:</dt>
                    <dd class="col-sm-8">
                        {% if project.is_public %}
                            <span class="badge bg-success"><i class="bi bi-globe"></i> Public</span>
                        {% else %}
                            <span class="badge bg-secondary"><i class="bi bi-lock"></i> Private</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-4">Created:</dt>
                    <dd class="col-sm-8">{{ project.created_at|date:"M d, Y H:i" }}</dd>
                    
                    <dt class="col-sm-4">Updated:</dt>
                    <dd class="col-sm-8">{{ project.updated_at|date:"M d, Y H:i" }}</dd>
                    
                    {% if project.docker_container_id %}
                    <dt class="col-sm-4">Container:</dt>
                    <dd class="col-sm-8">
                        <small class="text-muted">{{ project.docker_container_id|truncatechars:12 }}</small>
                    </dd>
                    {% endif %}
                </dl>
                
                <hr>
                
                <h6>GitHub Repository:</h6>
                <p><a href="{{ project.github_repo_url }}" target="_blank" class="text-decoration-none">
                    <i class="bi bi-github"></i> {{ project.github_repo_url|truncatechars:40 }}
                </a></p>
                
                <!-- Project Tags -->
                <h6 class="mt-3">Tags:</h6>
                <div class="d-flex flex-wrap gap-1 mb-2">
                    {% for tag in project.tags.all %}
                        <span class="badge bg-info">
                            {{ tag.name }}
                            <a href="#" class="text-white remove-tag" data-tag-id="{{ tag.id }}" data-project-id="{{ project.id }}">
                                <i class="bi bi-x"></i>
                            </a>
                        </span>
                    {% empty %}
                        <span class="text-muted">No tags</span>
                    {% endfor %}
                </div>
                <form id="addTagForm" class="d-flex mt-2">
                    <input type="hidden" name="project_id" value="{{ project.id }}">
                    <input type="text" name="tag_name" class="form-control form-control-sm me-2" placeholder="Add tag...">
                    <button type="submit" class="btn btn-sm btn-outline-primary">Add</button>
                </form>
            </div>
        </div>
        
        <!-- Environment Variables -->
        <div class="card mt-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-gear"></i> Environment Variables</h6>
                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addEnvVarModal">
                    <i class="bi bi-plus"></i> Add
                </button>
            </div>
            <div class="card-body">
                {% if env_vars %}
                <div class="list-group list-group-flush">
                    {% for env_var in env_vars %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ env_var.key }}</strong>
                            <br><small class="text-muted">
                                {% if env_var.is_secret %}
                                    ********
                                {% else %}
                                    {{ env_var.value }}
                                {% endif %}
                            </small>
                        </div>
                        <form method="post" action="{% url 'core:delete_env_var' env_var.id %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this environment variable?')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center mb-0">No environment variables set</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <!-- Deployment History -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Deployment History</h5>
            </div>
            <div class="card-body">
                {% if deployments %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Deployed At</th>
                                <th>Commit</th>
                                <th>Log</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for deployment in deployments %}
                            <tr>
                                <td>
                                    {% if deployment.status == 'success' %}
                                        <span class="badge bg-success">Success</span>
                                    {% elif deployment.status == 'failed' %}
                                        <span class="badge bg-danger">Failed</span>
                                    {% else %}
                                        <span class="badge bg-warning">{{ deployment.status|title }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ deployment.timestamp|date:"M d, Y H:i" }}</td>
                                <td>
                                    {% if deployment.commit_hash %}
                                        <small class="font-monospace">{{ deployment.commit_hash|truncatechars:8 }}</small>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">{{ deployment.log|truncatechars:50 }}</small>
                                </td>
                                <td>
                                    <a href="{% url 'core:deployment_detail' deployment.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i> View
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-clock display-4 text-muted"></i>
                    <p class="text-muted mt-2">No deployments yet</p>
                    <button class="btn btn-primary deploy-project" data-project-id="{{ project.id }}">
                        <i class="bi bi-play-circle"></i> Deploy Now
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Environment Variable Modal -->
<div class="modal fade" id="addEnvVarModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Environment Variable</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'core:add_env_var' project.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="key" class="form-label">Key</label>
                        <input type="text" class="form-control" id="key" name="key" required>
                    </div>
                    <div class="mb-3">
                        <label for="value" class="form-label">Value</label>
                        <input type="text" class="form-control" id="value" name="value" required>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="is_secret" name="is_secret">
                            <label class="form-check-label" for="is_secret">
                                Secret (value will be hidden)
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Variable</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Deploy project
document.querySelectorAll('.deploy-project').forEach(button => {
    button.addEventListener('click', function() {
        const projectId = this.dataset.projectId;
        const btn = this;
        
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Deploying...';
        
        fetch(`/projects/${projectId}/deploy/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Deployment failed: ' + data.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-play-circle"></i> Deploy';
            }
        })
        .catch(error => {
            alert('Error: ' + error);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-play-circle"></i> Deploy';
        });
    });
});

// Stop project
document.querySelectorAll('.stop-project').forEach(button => {
    button.addEventListener('click', function() {
        const projectId = this.dataset.projectId;
        const btn = this;
        
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Stopping...';
        
        fetch(`/projects/${projectId}/stop/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to stop: ' + data.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-stop-circle"></i> Stop';
            }
        })
        .catch(error => {
            alert('Error: ' + error);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-stop-circle"></i> Stop';
        });
    });
});

// Delete project
document.querySelectorAll('.delete-project').forEach(button => {
    button.addEventListener('click', function() {
        const projectId = this.dataset.projectId;
        
        if (confirm('Are you sure you want to delete this project? This will also remove the Docker container and cannot be undone.')) {
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Deleting...';
            
            fetch(`/projects/${projectId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = '{% url "core:dashboard" %}';
                } else {
                    alert('Failed to delete: ' + data.message);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-trash"></i> Delete';
                }
            })
            .catch(error => {
                alert('Error: ' + error);
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-trash"></i> Delete';
            });
        }
    });
});

// Add tag
document.getElementById('addTagForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const projectId = this.querySelector('input[name="project_id"]').value;
    const tagName = this.querySelector('input[name="tag_name"]').value.trim();
    
    if (!tagName) return;
    
    const btn = this.querySelector('button');
    btn.disabled = true;
    btn.innerHTML = 'Adding...';
    
    fetch('{% url "core:add_project_tag" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({
            'project_id': projectId,
            'tag_name': tagName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Add new tag to the list
            const tagsContainer = document.querySelector('.d-flex.flex-wrap.gap-1.mb-2');
            const emptyMessage = tagsContainer.querySelector('.text-muted');
            if (emptyMessage) {
                emptyMessage.remove();
            }
            
            const newTag = document.createElement('span');
            newTag.className = 'badge bg-info';
            newTag.innerHTML = `
                ${data.tag_name}
                <a href="#" class="text-white remove-tag" data-tag-id="${data.tag_id}" data-project-id="${projectId}">
                    <i class="bi bi-x"></i>
                </a>
            `;
            tagsContainer.appendChild(newTag);
            
            // Add event listener to the new remove button
            const newRemoveBtn = newTag.querySelector('.remove-tag');
            addRemoveTagListener(newRemoveBtn);
            
            // Clear input
            this.querySelector('input[name="tag_name"]').value = '';
        } else {
            alert('Failed to add tag: ' + data.message);
        }
        btn.disabled = false;
        btn.innerHTML = 'Add';
    })
    .catch(error => {
        alert('Error: ' + error);
        btn.disabled = false;
        btn.innerHTML = 'Add';
    });
});

// Remove tag
function addRemoveTagListener(element) {
    element.addEventListener('click', function(e) {
        e.preventDefault();
        const tagId = this.dataset.tagId;
        const projectId = this.dataset.projectId;
        const tagElement = this.closest('.badge');
        
        fetch('{% url "core:remove_project_tag" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                'project_id': projectId,
                'tag_id': tagId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                tagElement.remove();
                
                // If no tags left, show empty message
                const tagsContainer = document.querySelector('.d-flex.flex-wrap.gap-1.mb-2');
                if (tagsContainer.children.length === 0) {
                    tagsContainer.innerHTML = '<span class="text-muted">No tags</span>';
                }
            } else {
                alert('Failed to remove tag');
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    });
}

// Add listeners to existing remove tag buttons
document.querySelectorAll('.remove-tag').forEach(button => {
    addRemoveTagListener(button);
});
</script>
{% endblock %}